<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IGP å€‹åˆ¥è¼”å°è¨ˆç•«ç³»çµ±</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <script src="https://unpkg.com/docx@8.2.2/build/index.umd.js"></script>
  <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Noto Sans TC', sans-serif; }
    input, select, textarea, button { font-family: inherit; }
    input:focus, select:focus, textarea:focus { outline: 2px solid #9B8AC4; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyB_Gjscmk9pm31gsB5eVTBXtisIVFyDm6w",
      authDomain: "igp-system.firebaseapp.com",
      databaseURL: "https://igp-system-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "igp-system",
      storageBucket: "igp-system.firebasestorage.app",
      messagingSenderId: "403709187781",
      appId: "1:403709187781:web:2afd0b3d65d239f1fe02ac"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let state = {
      userRole: null, isAuthenticated: false, password: localStorage.getItem('igp_pwd') || '0424',
      step: 0, toast: '', submitting: false, submitted: false, loading: true,
      submissions: [], selectedStudent: null, form: getDefaultForm()
    };

    function getDefaultForm() {
      return {
        studentName: '', birthDate: '', gender: 'ç”·', email: '', homePhone: '', address: '',
        guardian: '', guardianPhone: '', guardianRelation: 'çˆ¶',
        schoolYear: '114', semester: 'ä¸Šå­¸æœŸ', school: '', grade: '3', classNumber: '', homeTeacher: '',
        actualCaregiver: 'çˆ¶', economicStatus: 'å°åº·', parentingStyle: 'æ°‘ä¸»å¼', familyInteraction: 'è‰¯å¥½', parentExpectation: '',
        scienceInterests: [], humanitiesInterests: [], otherInterests: [],
        cognitiveTraits: {}, emotionalTraits: {},
        identificationNumber: '', caseTeacher: '',
        educationStage: 'åœ‹å°', giftedType: 'å‰µé€ èƒ½åŠ›', placementType: 'åˆ†æ•£å¼è³‡æºç­',
        familyMembers: [{ relation: '', name: '', education: '', specialty: '', phone: '', workplace: '' }],
        strengths: [], weaknesses: [], analysisDescription: '',
        analysisDate: '', analysisWriter: '',
        courses: [{ domain: '', courseName: '', teacher: '', goals: '' }],
        timetable: {}, timetableNote: '',
        meetings: [{ title: '', date: '', time: '', location: '', attendees: '', content: '', recorder: '' }]
      };
    }

    function setState(newState) { state = { ...state, ...newState }; render(); }
    function showToast(msg) { state.toast = msg; render(); setTimeout(() => { state.toast = ''; render(); }, 3000); }

    const styles = {
      inputP: 'width:100%;padding:12px;border:2px solid #FFD1DC;border-radius:12px;font-size:1rem;background:#FFF9F9;',
      inputT: 'width:100%;padding:12px;border:2px solid #A8E6E0;border-radius:12px;font-size:1rem;background:#FFF9F0;',
      label: 'display:block;margin-bottom:6px;font-weight:600;font-size:0.9rem;color:#4A4A6A;'
    };

    function render() {
      const root = document.getElementById('root');
      if (!state.userRole) root.innerHTML = renderRoleSelection();
      else if (state.userRole === 'teacher' && !state.isAuthenticated) root.innerHTML = renderTeacherLogin();
      else if (state.userRole === 'parent') root.innerHTML = renderParentVersion();
      else if (state.userRole === 'teacher') root.innerHTML = renderTeacherVersion();
      bindEvents();
    }

    function renderRoleSelection() {
      return `<div style="font-family:'Noto Sans TC',sans-serif;min-height:100vh;padding:20px;background:linear-gradient(135deg,#667eea 0%,#764ba2 50%,#f093fb 100%);display:flex;align-items:center;justify-content:center;">
        <div style="background:white;border-radius:30px;padding:40px;box-shadow:0 15px 50px rgba(0,0,0,0.1);max-width:500px;width:100%;">
          <div style="text-align:center;margin-bottom:40px;">
            <div style="font-size:4rem;margin-bottom:20px;">ğŸ“š</div>
            <h1 style="font-size:2rem;font-weight:800;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">IGP å€‹åˆ¥è¼”å°è¨ˆç•«ç³»çµ±</h1>
            <p style="color:#6B6B8D;margin-top:10px;">è³‡è³¦å„ªç•°å­¸ç”Ÿå€‹åˆ¥è¼”å°è¨ˆç•«å¡«å¯«å¹³å°</p>
          </div>
          <div style="display:flex;flex-direction:column;gap:20px;">
            <button onclick="setState({userRole:'parent',step:0})" style="padding:25px;border:none;border-radius:20px;background:linear-gradient(135deg,#FF9A8B 0%,#FF6B95 100%);color:white;font-size:1.2rem;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:15px;">
              <span style="font-size:2rem;">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</span><div style="text-align:left;"><div>æˆ‘æ˜¯å®¶é•·</div><div style="font-size:0.85rem;opacity:0.9;">å¡«å¯«å­¸ç”Ÿè³‡æ–™</div></div>
            </button>
            <button onclick="setState({userRole:'teacher',step:0})" style="padding:25px;border:none;border-radius:20px;background:linear-gradient(135deg,#7ECEC6 0%,#5EBEB6 100%);color:white;font-size:1.2rem;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:15px;">
              <span style="font-size:2rem;">ğŸ‘©â€ğŸ«</span><div style="text-align:left;"><div>æˆ‘æ˜¯æ•™å¸«</div><div style="font-size:0.85rem;opacity:0.9;">å®Œæˆ IGP ä¸¦åŒ¯å‡º</div></div>
            </button>
          </div>
        </div>
      </div>`;
    }

    function renderTeacherLogin() {
      return `<div style="font-family:'Noto Sans TC',sans-serif;min-height:100vh;padding:20px;background:linear-gradient(135deg,#A8E6E0 0%,#FFF9F0 50%,#FFF8DC 100%);display:flex;align-items:center;justify-content:center;">
        <div style="background:white;border-radius:30px;padding:40px;box-shadow:0 15px 50px rgba(0,0,0,0.1);max-width:400px;width:100%;">
          <div style="text-align:center;margin-bottom:30px;"><div style="font-size:4rem;">ğŸ”</div><h1 style="font-size:1.8rem;font-weight:800;color:#7ECEC6;">æ•™å¸«ç™»å…¥</h1></div>
          <input type="password" id="passwordInput" placeholder="è«‹è¼¸å…¥æ•™å¸«å¯†ç¢¼" style="width:100%;padding:15px;border:2px solid #A8E6E0;border-radius:15px;font-size:1rem;margin-bottom:15px;" />
          <p id="passwordError" style="color:#FF6B6B;text-align:center;margin-bottom:15px;display:none;">å¯†ç¢¼éŒ¯èª¤</p>
          <button onclick="handleLogin()" style="width:100%;padding:15px;border:none;border-radius:15px;background:linear-gradient(135deg,#7ECEC6 0%,#5EBEB6 100%);color:white;font-size:1.1rem;font-weight:700;cursor:pointer;margin-bottom:10px;">ç™»å…¥</button>
          <button onclick="setState({userRole:null})" style="width:100%;padding:15px;border:2px solid #7ECEC6;border-radius:15px;background:white;color:#7ECEC6;font-size:1rem;font-weight:600;cursor:pointer;">â† è¿”å›</button>
        </div>
      </div>`;
    }

    function handleLogin() {
      const pwd = document.getElementById('passwordInput').value;
      if (pwd === state.password) { setState({ isAuthenticated: true }); loadSubmissions(); }
      else document.getElementById('passwordError').style.display = 'block';
    }

    // ===== å®¶é•·ç‰ˆ =====
    function renderParentVersion() {
      const steps = ['åŸºæœ¬è³‡æ–™', 'å®¶åº­èƒŒæ™¯', 'èˆˆè¶£è©•é‡', 'ç‰¹è³ªè©•ä¼°', 'ç¢ºèªç¹³äº¤'];
      return `<div style="font-family:'Noto Sans TC',sans-serif;background:linear-gradient(135deg,#FFE4E1 0%,#FFF9F0 50%,#E8F5E9 100%);min-height:100vh;padding:20px;">
        <header style="background:linear-gradient(135deg,#FF9A8B 0%,#FF6B95 100%);border-radius:20px;padding:20px;margin-bottom:20px;display:flex;justify-content:space-between;align-items:center;">
          <h1 style="color:white;font-size:1.4rem;margin:0;">IGP å®¶é•·ç‰ˆ ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</h1>
          <button onclick="setState({userRole:null,step:0,submitted:false})" style="padding:8px 16px;border:2px solid white;border-radius:10px;background:transparent;color:white;font-weight:600;cursor:pointer;">â† è¿”å›</button>
        </header>
        <div style="background:white;border-radius:15px;padding:12px;margin-bottom:20px;display:flex;justify-content:space-between;gap:5px;">
          ${steps.map((s,i)=>`<div onclick="setState({step:${i}})" style="display:flex;flex-direction:column;align-items:center;cursor:pointer;flex:1;">
            <div style="width:35px;height:35px;border-radius:50%;background:${state.step===i?'#FF6B95':state.step>i?'#4CAF50':'#FFD1DC'};color:white;display:flex;align-items:center;justify-content:center;font-weight:700;">${state.step>i?'âœ“':i+1}</div>
            <span style="font-size:0.65rem;margin-top:4px;color:${state.step===i?'#FF6B95':'#666'};">${s}</span>
          </div>`).join('')}
        </div>
        <div style="background:white;border-radius:20px;padding:25px;margin-bottom:20px;">${renderParentStep()}</div>
        ${state.step<4&&!state.submitted?`<div style="display:flex;gap:10px;justify-content:center;">
          ${state.step>0?`<button onclick="setState({step:state.step-1})" style="padding:12px 30px;border:2px solid #FF6B95;border-radius:15px;background:white;color:#FF6B95;font-weight:700;cursor:pointer;">â† ä¸Šä¸€æ­¥</button>`:''}
          <button onclick="setState({step:state.step+1})" style="padding:12px 30px;border:none;border-radius:15px;background:linear-gradient(135deg,#FF6B95 0%,#FF8E53 100%);color:white;font-weight:700;cursor:pointer;">ä¸‹ä¸€æ­¥ â†’</button>
        </div>`:''}
        ${state.toast?`<div style="position:fixed;bottom:20px;right:20px;background:${state.toast.includes('âŒ')?'#FF6B6B':'#4CAF50'};color:white;padding:15px 25px;border-radius:10px;font-weight:600;z-index:1000;">${state.toast}</div>`:''}
      </div>`;
    }

    function renderParentStep() {
      const f = state.form;
      switch(state.step) {
        case 0: return `<h3 style="color:#FF6B95;margin-bottom:15px;">ğŸ‘¤ åŸºæœ¬è³‡æ–™</h3>
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;">
            <div><label style="${styles.label}">å­¸ç”Ÿå§“å *</label><input type="text" id="studentName" value="${f.studentName}" style="${styles.inputP}" /></div>
            <div><label style="${styles.label}">å‡ºç”Ÿæ—¥æœŸ</label><input type="date" id="birthDate" value="${f.birthDate}" style="${styles.inputP}" /></div>
            <div><label style="${styles.label}">æ€§åˆ¥</label><select id="gender" style="${styles.inputP}"><option ${f.gender==='ç”·'?'selected':''}>ç”·</option><option ${f.gender==='å¥³'?'selected':''}>å¥³</option></select></div>
            <div><label style="${styles.label}">å­¸å¹´åº¦</label><input type="text" id="schoolYear" value="${f.schoolYear}" style="${styles.inputP}" /></div>
            <div><label style="${styles.label}">å­¸æ ¡ *</label><input type="text" id="school" value="${f.school}" style="${styles.inputP}" placeholder="ä¾‹ï¼šåŒå¾·åœ‹å°" /></div>
            <div><label style="${styles.label}">å¹´ç´š</label><select id="grade" style="${styles.inputP}">${[1,2,3,4,5,6].map(g=>`<option ${f.grade==g?'selected':''}>${g}</option>`).join('')}</select></div>
            <div><label style="${styles.label}">ç­ç´š</label><input type="text" id="classNumber" value="${f.classNumber}" style="${styles.inputP}" /></div>
            <div><label style="${styles.label}">å°å¸«</label><input type="text" id="homeTeacher" value="${f.homeTeacher}" style="${styles.inputP}" /></div>
            <div><label style="${styles.label}">E-mail</label><input type="email" id="email" value="${f.email||''}" style="${styles.inputP}" /></div>
            <div><label style="${styles.label}">ä½å€</label><input type="text" id="address" value="${f.address||''}" style="${styles.inputP}" /></div>
            <div><label style="${styles.label}">æ³•å®šä»£ç†äºº *</label><input type="text" id="guardian" value="${f.guardian}" style="${styles.inputP}" /></div>
            <div><label style="${styles.label}">ä»£ç†äººé—œä¿‚</label><select id="guardianRelation" style="${styles.inputP}">${['çˆ¶','æ¯','ç¥–çˆ¶','ç¥–æ¯','å…¶ä»–'].map(r=>`<option ${f.guardianRelation===r?'selected':''}>${r}</option>`).join('')}</select></div>
            <div><label style="${styles.label}">ä»£ç†äººé›»è©±</label><input type="tel" id="guardianPhone" value="${f.guardianPhone}" style="${styles.inputP}" /></div>
          </div>`;
        case 1: return `<h3 style="color:#FF6B95;margin-bottom:15px;">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ å®¶åº­ç‹€æ³</h3>
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;">
            <div><label style="${styles.label}">å¯¦éš›ç…§é¡§è€…</label><select id="actualCaregiver" style="${styles.inputP}">${['çˆ¶','æ¯','çˆ¶æ¯','ç¥–çˆ¶æ¯','å…¶ä»–'].map(c=>`<option ${f.actualCaregiver===c?'selected':''}>${c}</option>`).join('')}</select></div>
            <div><label style="${styles.label}">å®¶åº­ç¶“æ¿Ÿç‹€æ³</label><select id="economicStatus" style="${styles.inputP}">${['å¯Œè£•','å°åº·','æ™®é€š','æ¸…å¯’'].map(e=>`<option ${f.economicStatus===e?'selected':''}>${e}</option>`).join('')}</select></div>
            <div><label style="${styles.label}">ç®¡æ•™æ…‹åº¦</label><select id="parentingStyle" style="${styles.inputP}">${['æ°‘ä¸»å¼','æ¬Šå¨å¼','æ”¾ä»»å¼','æººæ„›å¼'].map(p=>`<option ${f.parentingStyle===p?'selected':''}>${p}</option>`).join('')}</select></div>
            <div><label style="${styles.label}">èˆ‡å®¶äººäº’å‹•</label><select id="familyInteraction" style="${styles.inputP}">${['è‰¯å¥½','æ™®é€š','ä¸ä½³'].map(i=>`<option ${f.familyInteraction===i?'selected':''}>${i}</option>`).join('')}</select></div>
          </div>
          <div style="margin-top:15px;"><label style="${styles.label}">å°å­©å­çš„æœŸæœ›</label><textarea id="parentExpectation" style="${styles.inputP}min-height:80px;">${f.parentExpectation}</textarea></div>`;
        case 2:
          const sci=['æ•¸å­¸','è³‡è¨Šç§‘æŠ€','ç”Ÿæ´»ç§‘æŠ€','ç‰©ç†','åŒ–å­¸','ç”Ÿç‰©','åœ°çƒç§‘å­¸'];
          const hum=['åœ‹æ–‡','è‹±æ–‡','æ­·å²','åœ°ç†','ç¾è¡“','éŸ³æ¨‚','è¨­è¨ˆ'];
          const oth=['é«”è‚²','æ°‘ä¿—é«”è‚²','æ—…éŠ','åœæ£‹','æ¨‚é«˜','å…¶ä»–'];
          return `<h3 style="color:#FF6B95;margin-bottom:15px;">ğŸ“Š èˆˆè¶£åˆ†æ</h3>
            <div style="margin-bottom:15px;"><label style="${styles.label}">ç§‘å­¸èˆˆè¶£</label><div style="display:flex;flex-wrap:wrap;gap:6px;">${sci.map(item=>`<div onclick="toggleInterest('scienceInterests','${item}')" style="padding:8px 15px;border-radius:15px;cursor:pointer;background:${f.scienceInterests.includes(item)?'#FF6B95':'#FFE4EC'};color:${f.scienceInterests.includes(item)?'white':'#4A4A6A'};">${f.scienceInterests.includes(item)?'âœ“ ':''}${item}</div>`).join('')}</div></div>
            <div style="margin-bottom:15px;"><label style="${styles.label}">äººæ–‡èˆ‡è—è¡“èˆˆè¶£</label><div style="display:flex;flex-wrap:wrap;gap:6px;">${hum.map(item=>`<div onclick="toggleInterest('humanitiesInterests','${item}')" style="padding:8px 15px;border-radius:15px;cursor:pointer;background:${f.humanitiesInterests.includes(item)?'#FF6B95':'#FFE4EC'};color:${f.humanitiesInterests.includes(item)?'white':'#4A4A6A'};">${f.humanitiesInterests.includes(item)?'âœ“ ':''}${item}</div>`).join('')}</div></div>
            <div><label style="${styles.label}">å…¶ä»–</label><div style="display:flex;flex-wrap:wrap;gap:6px;">${oth.map(item=>`<div onclick="toggleInterest('otherInterests','${item}')" style="padding:8px 15px;border-radius:15px;cursor:pointer;background:${f.otherInterests.includes(item)?'#FF6B95':'#FFE4EC'};color:${f.otherInterests.includes(item)?'white':'#4A4A6A'};">${f.otherInterests.includes(item)?'âœ“ ':''}${item}</div>`).join('')}</div></div>`;
        case 3:
          const cog=['è§€å¯Ÿèƒ½åŠ›','è¨˜æ†¶èƒ½åŠ›','ç†è§£èƒ½åŠ›','æ¨ç†èƒ½åŠ›','åˆ†æèƒ½åŠ›','æ‡‰ç”¨èƒ½åŠ›','è©•é‘‘èƒ½åŠ›','å‰µé€ èƒ½åŠ›','æ‰¹åˆ¤èƒ½åŠ›','å•é¡Œè§£æ±º','å¾Œè¨­èƒ½åŠ›'];
          const emo=['å°ˆæ³¨èƒ½åŠ›','æˆå°±å‹•æ©Ÿ','è¦æ±‚å®Œç¾','æºé€šå”èª¿','æƒ…ç·’æ§åˆ¶','æŒ«æŠ˜å®¹å¿','æ­£å‘æ€è€ƒ','é ˜å°èƒ½åŠ›','åˆä½œèƒ½åŠ›','è‡ªä¿¡å¿ƒ','åŒç†å¿ƒ','å¾©åŸåŠ›'];
          return `<h3 style="color:#FF6B95;margin-bottom:15px;">â­ ç‰¹è³ªè©•ä¼°ï¼ˆ1-5åˆ†ï¼‰</h3>
            <div style="margin-bottom:15px;"><label style="${styles.label}">èªçŸ¥ç‰¹è³ª</label><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:6px;">${cog.map(item=>`<div style="background:#FFF9F9;padding:6px;border-radius:6px;"><div style="font-size:0.75rem;margin-bottom:4px;">${item}</div><div style="display:flex;gap:2px;">${[1,2,3,4,5].map(n=>`<button onclick="setRating('cognitiveTraits','${item}',${n})" style="width:24px;height:24px;border-radius:4px;border:1px solid #FFD1DC;background:${f.cognitiveTraits[item]===n?'#FF6B95':'white'};color:${f.cognitiveTraits[item]===n?'white':'#4A4A6A'};cursor:pointer;font-size:0.7rem;">${n}</button>`).join('')}</div></div>`).join('')}</div></div>
            <div><label style="${styles.label}">æƒ…æ„ç‰¹è³ª</label><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:6px;">${emo.map(item=>`<div style="background:#FFF9F9;padding:6px;border-radius:6px;"><div style="font-size:0.75rem;margin-bottom:4px;">${item}</div><div style="display:flex;gap:2px;">${[1,2,3,4,5].map(n=>`<button onclick="setRating('emotionalTraits','${item}',${n})" style="width:24px;height:24px;border-radius:4px;border:1px solid #FFD1DC;background:${f.emotionalTraits[item]===n?'#FF6B95':'white'};color:${f.emotionalTraits[item]===n?'white':'#4A4A6A'};cursor:pointer;font-size:0.7rem;">${n}</button>`).join('')}</div></div>`).join('')}</div></div>`;
        case 4:
          if(state.submitted) return `<div style="text-align:center;background:#E8F5E9;border-radius:20px;padding:40px;"><div style="font-size:4rem;">ğŸ‰</div><h3 style="color:#4CAF50;margin:15px 0;">è³‡æ–™å·²æˆåŠŸç¹³äº¤ï¼</h3><button onclick="setState({userRole:null,step:0,submitted:false})" style="margin-top:20px;padding:12px 30px;border:2px solid #4CAF50;border-radius:15px;background:white;color:#4CAF50;font-weight:700;cursor:pointer;">â† è¿”å›é¦–é </button></div>`;
          return `<div style="text-align:center;"><h3 style="color:#FF6B95;margin-bottom:20px;">âœ… ç¢ºèªç¹³äº¤</h3>
            <div style="background:#FFE4EC;border-radius:15px;padding:20px;margin-bottom:20px;text-align:left;">
              <p><strong>å­¸ç”Ÿï¼š</strong>${f.studentName||'æœªå¡«'}</p>
              <p><strong>å­¸æ ¡ï¼š</strong>${f.school} ${f.grade}å¹´${f.classNumber}ç­</p>
              <p><strong>ä»£ç†äººï¼š</strong>${f.guardian||'æœªå¡«'}</p>
            </div>
            <button onclick="submitToFirebase()" ${state.submitting?'disabled':''} style="padding:18px 50px;border:none;border-radius:20px;background:${state.submitting?'#ccc':'linear-gradient(135deg,#4CAF50 0%,#45a049 100%)'};color:white;font-size:1.2rem;font-weight:700;cursor:pointer;">${state.submitting?'â³ ç¹³äº¤ä¸­...':'ğŸ“¤ ç¢ºèªç¹³äº¤'}</button>
          </div>`;
      }
    }

    function toggleInterest(field, item) {
      const curr = state.form[field] || [];
      state.form[field] = curr.includes(item) ? curr.filter(i=>i!==item) : [...curr,item];
      render();
    }

    function setRating(cat, item, val) {
      state.form[cat] = { ...state.form[cat], [item]: val };
      render();
    }

    async function submitToFirebase() {
      saveFormData();
      const f = state.form;
      if(!f.studentName||!f.school||!f.guardian) { showToast('âŒ è«‹å¡«å¯«å¿…è¦æ¬„ä½'); return; }
      state.submitting = true; render();
      try {
        const key = `${f.school}_${f.grade}_${f.classNumber}_${f.studentName}`.replace(/[.#$\/\[\]]/g,'_');
        await db.ref('submissions/'+key).set({...f, submittedAt: new Date().toISOString(), status:'pending'});
        state.submitted = true;
        showToast('âœ… è³‡æ–™å·²æˆåŠŸç¹³äº¤ï¼');
      } catch(e) { showToast('âŒ ç¹³äº¤å¤±æ•—'); }
      state.submitting = false; render();
    }

    // ===== æ•™å¸«ç‰ˆ =====
    function renderTeacherVersion() {
      const steps = ['å­¸ç”Ÿåˆ—è¡¨','åŸºæœ¬è³‡æ–™','å„ªå¼±å‹¢','èª²ç¨‹è¨ˆç•«','èª²è¡¨','æœƒè­°','åŒ¯å‡º'];
      return `<div style="font-family:'Noto Sans TC',sans-serif;background:linear-gradient(135deg,#A8E6E0 0%,#FFF9F0 50%,#FFF8DC 100%);min-height:100vh;padding:20px;">
        <header style="background:#9B8AC4;border-radius:20px;padding:20px;margin-bottom:20px;display:flex;justify-content:space-between;align-items:center;">
          <h1 style="color:white;font-size:1.4rem;margin:0;">IGP æ•™å¸«ç‰ˆ ğŸ‘©â€ğŸ«</h1>
          <button onclick="setState({userRole:null,isAuthenticated:false,step:0,selectedStudent:null})" style="padding:8px 16px;border:2px solid white;border-radius:10px;background:transparent;color:white;font-weight:600;cursor:pointer;">â† ç™»å‡º</button>
        </header>
        <div style="background:white;border-radius:15px;padding:10px;margin-bottom:20px;overflow-x:auto;">
          <div style="display:flex;justify-content:space-between;min-width:500px;gap:3px;">
            ${steps.map((s,i)=>`<div onclick="${i===0||state.selectedStudent?`setState({step:${i}})`:''}" style="display:flex;flex-direction:column;align-items:center;cursor:${i===0||state.selectedStudent?'pointer':'not-allowed'};flex:1;opacity:${i>0&&!state.selectedStudent?0.5:1};"><div style="width:30px;height:30px;border-radius:50%;background:${state.step===i?'#9B8AC4':state.step>i?'#7ECEC6':'#A8E6E0'};color:white;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.7rem;">${state.step>i?'âœ“':i+1}</div><span style="font-size:0.55rem;margin-top:3px;color:${state.step===i?'#9B8AC4':'#666'};">${s}</span></div>`).join('')}
          </div>
        </div>
        <div style="background:white;border-radius:20px;padding:25px;margin-bottom:20px;">${renderTeacherStep()}</div>
        ${state.step>0&&state.selectedStudent?`<div style="display:flex;gap:10px;justify-content:center;">
          <button onclick="setState({step:state.step-1})" style="padding:12px 30px;border:2px solid #9B8AC4;border-radius:15px;background:white;color:#9B8AC4;font-weight:700;cursor:pointer;">â† ä¸Šä¸€æ­¥</button>
          ${state.step<6?`<button onclick="setState({step:state.step+1})" style="padding:12px 30px;border:none;border-radius:15px;background:linear-gradient(135deg,#9B8AC4 0%,#7B6BA4 100%);color:white;font-weight:700;cursor:pointer;">ä¸‹ä¸€æ­¥ â†’</button>`:''}
        </div>`:''}
        ${state.toast?`<div style="position:fixed;bottom:20px;right:20px;background:${state.toast.includes('âŒ')?'#FF6B6B':'#7ECEC6'};color:white;padding:15px 25px;border-radius:10px;font-weight:600;z-index:1000;">${state.toast}</div>`:''}
      </div>`;
    }

    function renderTeacherStep() {
      const f = state.form;
      switch(state.step) {
        case 0: return renderStudentList();
        case 1: return `<h3 style="color:#9B8AC4;margin-bottom:15px;">ğŸ‘¤ åŸºæœ¬è³‡æ–™</h3>
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;">
            <div><label style="${styles.label}">å­¸ç”Ÿå§“å</label><input type="text" value="${f.studentName}" style="${styles.inputT}" readonly /></div>
            <div><label style="${styles.label}">é‘‘å®šæ–‡è™Ÿ</label><input type="text" id="identificationNumber" value="${f.identificationNumber||''}" style="${styles.inputT}" placeholder="113å¹´4æœˆ22æ—¥åºœæ•™ç‰¹å­—ç¬¬..." /></div>
            <div><label style="${styles.label}">å­¸æ ¡/ç­ç´š</label><input type="text" value="${f.school} ${f.grade}å¹´${f.classNumber}ç­" style="${styles.inputT}" readonly /></div>
            <div><label style="${styles.label}">åŸç­å°å¸«</label><input type="text" id="homeTeacher" value="${f.homeTeacher||''}" style="${styles.inputT}" /></div>
            <div><label style="${styles.label}">å€‹ç®¡æ•™å¸«</label><input type="text" id="caseTeacher" value="${f.caseTeacher||''}" style="${styles.inputT}" /></div>
            <div><label style="${styles.label}">æ•™è‚²éšæ®µ</label><select id="educationStage" style="${styles.inputT}">${['åœ‹å°','åœ‹ä¸­'].map(s=>`<option ${f.educationStage===s?'selected':''}>${s}</option>`).join('')}</select></div>
            <div><label style="${styles.label}">è³‡å„ªé¡åˆ¥</label><select id="giftedType" style="${styles.inputT}">${['å‰µé€ èƒ½åŠ›','ä¸€èˆ¬æ™ºèƒ½','å­¸è¡“æ€§å‘','è—è¡“æ‰èƒ½','é ˜å°æ‰èƒ½'].map(t=>`<option ${f.giftedType===t?'selected':''}>${t}</option>`).join('')}</select></div>
            <div><label style="${styles.label}">å®‰ç½®æ–¹å¼</label><select id="placementType" style="${styles.inputT}">${['åˆ†æ•£å¼è³‡æºç­','é›†ä¸­å¼ç‰¹æ•™ç­','å·¡è¿´è¼”å°','è³‡å„ªæ•™è‚²æ–¹æ¡ˆ'].map(p=>`<option ${f.placementType===p?'selected':''}>${p}</option>`).join('')}</select></div>
          </div>`;
        case 2:
          const traits=['â‘ è§€å¯Ÿèƒ½åŠ›','â‘¡è¨˜æ†¶èƒ½åŠ›','â‘¢ç†è§£èƒ½åŠ›','â‘£æ¨ç†èƒ½åŠ›','â‘¤åˆ†æèƒ½åŠ›','â‘¥æ‡‰ç”¨èƒ½åŠ›','â‘¦è©•é‘‘èƒ½åŠ›','â‘§å‰µé€ èƒ½åŠ›','â‘¨æ‰¹åˆ¤èƒ½åŠ›','â‘©å•é¡Œè§£æ±º','â‘ªå¾Œè¨­èƒ½åŠ›','â‘¬å°ˆæ³¨èƒ½åŠ›','â‘­æˆå°±å‹•æ©Ÿ','â‘®è¦æ±‚å®Œç¾','â‘¯æºé€šå”èª¿','â‘°æƒ…ç·’æ§åˆ¶','â‘±æŒ«æŠ˜å®¹å¿','â‘²æ­£å‘æ€è€ƒ','â‘³é ˜å°èƒ½åŠ›','ã‰‘åˆä½œèƒ½åŠ›','ã‰’è‡ªä¿¡å¿ƒ','ã‰“åŒç†å¿ƒ','ã‰”å¾©åŸåŠ›','ã‰–æ•¸å­¸','ã‰—ç‰©ç†','ã‰˜ç”Ÿç‰©','ã‰™åŒ–å­¸','ã‰šåœ°ç§‘','ã‰›åœ‹æ–‡','ã‰œè‹±æ–‡','ã‰æ­·å²','ã‰åœ°ç†','ã‰Ÿå…¬æ°‘','ãŠ±è³‡è¨Š','ãŠ²ç”Ÿç§‘'];
          return `<h3 style="color:#9B8AC4;margin-bottom:15px;">âš–ï¸ å„ªå¼±å‹¢èƒ½åŠ›è©•æ</h3>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-bottom:15px;">
              <div><label style="${styles.label}">å¡«å¯«æ—¥æœŸ</label><input type="text" id="analysisDate" value="${f.analysisDate||''}" style="${styles.inputT}" placeholder="114/8/30" /></div>
              <div><label style="${styles.label}">å¡«å¯«è€…</label><input type="text" id="analysisWriter" value="${f.analysisWriter||''}" style="${styles.inputT}" placeholder="åŠ‰åŠ›ç‘„(æ•™å¸«)" /></div>
            </div>
            <p style="margin-bottom:10px;font-size:0.85rem;"><span style="color:#7ECEC6;">â– ç¶ =å„ªå‹¢</span> | <span style="color:#E8A5A5;">â– ç²‰=å¼±å‹¢</span></p>
            <div style="display:flex;flex-wrap:wrap;gap:3px;margin-bottom:15px;">
              ${traits.map(t=>`<div style="display:flex;gap:1px;"><div onclick="toggleTrait('strengths','${t}')" style="padding:3px 5px;border-radius:6px;cursor:pointer;font-size:0.6rem;background:${(f.strengths||[]).includes(t)?'#7ECEC6':'#F5E6B8'};color:${(f.strengths||[]).includes(t)?'white':'#4A4A6A'};">${t}â†‘</div><div onclick="toggleTrait('weaknesses','${t}')" style="padding:3px 5px;border-radius:6px;cursor:pointer;font-size:0.6rem;background:${(f.weaknesses||[]).includes(t)?'#F5C4C4':'#F5E6B8'};color:${(f.weaknesses||[]).includes(t)?'white':'#4A4A6A'};">â†“</div></div>`).join('')}
            </div>
            <div><label style="${styles.label}">å„ªå¼±å‹¢èƒ½åŠ›ç¶œåˆè©•æï¼ˆè³ªæ€§æè¿°ï¼‰</label><textarea id="analysisDescription" style="${styles.inputT}min-height:150px;">${f.analysisDescription||''}</textarea></div>`;
        case 3: return renderCurriculum();
        case 4: return renderTimetable();
        case 5: return renderMeetings();
        case 6: return renderExport();
      }
    }

    function toggleTrait(field, trait) {
      const curr = state.form[field] || [];
      state.form[field] = curr.includes(trait) ? curr.filter(t=>t!==trait) : [...curr,trait];
      render();
    }

    function loadSubmissions() {
      db.ref('submissions').on('value', snapshot => {
        const data = snapshot.val();
        state.submissions = data ? Object.entries(data).map(([key,value])=>({key,...value})).sort((a,b)=>new Date(b.submittedAt)-new Date(a.submittedAt)) : [];
        state.loading = false;
        render();
      });
    }

    function renderStudentList() {
      if(state.loading) return `<div style="text-align:center;padding:40px;"><div style="font-size:2rem;">â³</div><p>è¼‰å…¥ä¸­...</p></div>`;
      if(state.submissions.length===0) return `<div style="text-align:center;padding:40px;"><div style="font-size:3rem;">ğŸ“­</div><p>ç›®å‰æ²’æœ‰å®¶é•·ç¹³äº¤çš„è³‡æ–™</p></div>`;
      return `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
        <h3 style="color:#9B8AC4;margin:0;">ğŸ“‹ å·²ç¹³äº¤å­¸ç”Ÿï¼ˆ${state.submissions.length}ç­†ï¼‰</h3>
        <button onclick="window.location.reload()" style="padding:8px 15px;border:none;border-radius:10px;background:#7ECEC6;color:white;cursor:pointer;">ğŸ”„ é‡æ–°æ•´ç†</button>
      </div>
      ${state.submissions.map((sub,i)=>`<div onclick="selectStudent(${i})" style="background:white;border-radius:15px;padding:15px;margin-bottom:10px;border:2px solid #A8E6E0;cursor:pointer;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div><div style="font-weight:700;">${sub.studentName}</div><div style="color:#666;font-size:0.85rem;">${sub.school} ${sub.grade}å¹´${sub.classNumber}ç­</div></div>
          <div style="text-align:right;"><div style="padding:4px 10px;border-radius:10px;font-size:0.75rem;background:#FFF3E0;color:#FF9800;">å¾…è™•ç†</div></div>
        </div>
      </div>`).join('')}`;
    }

    function selectStudent(index) {
      const student = state.submissions[index];
      state.form = { ...getDefaultForm(), ...student };
      state.selectedStudent = student;
      state.step = 1;
      showToast(`âœ… å·²è¼‰å…¥ ${student.studentName} çš„è³‡æ–™`);
    }

    function renderCurriculum() {
      const f = state.form;
      const domains = ['é ˜å°æ‰èƒ½(èåˆå‰µé€ åŠ›)','å°ˆé•·é ˜åŸŸ(èåˆå‰µé€ åŠ›)','å‰µé€ åŠ›é ˜åŸŸ(èåˆç¨ç«‹ç ”ç©¶)','æƒ…æ„','å‰µé€ èƒ½åŠ›','é ˜å°æ‰èƒ½','ç¨ç«‹ç ”ç©¶','æƒ…æ„ç™¼å±•','å°ˆé•·é ˜åŸŸ'];
      return `<h3 style="color:#9B8AC4;margin-bottom:15px;">ğŸ“š æ•™è‚²ç›®æ¨™èˆ‡è¼”å°é‡é»</h3>
        ${(f.courses||[]).map((c,i)=>`<div style="background:#FFF9F0;border-radius:10px;padding:15px;margin-bottom:15px;border:2px solid #A8E6E0;position:relative;">
          ${i>0?`<button onclick="removeCourse(${i})" style="position:absolute;top:10px;right:10px;width:24px;height:24px;border-radius:50%;border:none;background:#F5C4C4;color:white;cursor:pointer;">Ã—</button>`:''}
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-bottom:10px;">
            <div><label style="${styles.label}">å­¸ç¿’é ˜åŸŸ</label><select id="course_domain_${i}" style="${styles.inputT}">${domains.map(d=>`<option ${c.domain===d?'selected':''}>${d}</option>`).join('')}</select></div>
            <div><label style="${styles.label}">èª²ç¨‹åç¨±</label><input type="text" id="course_name_${i}" value="${c.courseName||''}" style="${styles.inputT}" /></div>
            <div><label style="${styles.label}">æˆèª²æ•™å¸«</label><input type="text" id="course_teacher_${i}" value="${c.teacher||''}" style="${styles.inputT}" /></div>
          </div>
          <div><label style="${styles.label}">å­¸å¹´/å­¸æœŸç›®æ¨™</label><textarea id="course_goals_${i}" style="${styles.inputT}min-height:100px;">${c.goals||''}</textarea></div>
        </div>`).join('')}
        <button onclick="addCourse()" style="width:100%;padding:10px;border:2px dashed #7ECEC6;border-radius:10px;background:transparent;color:#7ECEC6;font-weight:700;cursor:pointer;">+ æ–°å¢èª²ç¨‹</button>`;
    }

    function addCourse() { saveFormData(); state.form.courses=[...(state.form.courses||[]),{domain:'å‰µé€ èƒ½åŠ›',courseName:'',teacher:'',goals:''}]; render(); }
    function removeCourse(i) { saveFormData(); state.form.courses=state.form.courses.filter((_,idx)=>idx!==i); render(); }

    function renderTimetable() {
      const days=['ä¸€','äºŒ','ä¸‰','å››','äº”'];
      const periods=['æ—©è‡ªç¿’','1','2','3','4','åˆä¼‘','5','6','7'];
      const tt=state.form.timetable||{};
      return `<h3 style="color:#9B8AC4;margin-bottom:15px;">ğŸ“… èª²è¡¨</h3>
        <div style="overflow-x:auto;"><table style="width:100%;border-collapse:separate;border-spacing:2px;min-width:400px;">
          <thead><tr><th style="background:#9B8AC4;color:white;padding:6px;border-radius:4px;font-size:0.75rem;">ç¯€æ¬¡</th>${days.map(d=>`<th style="background:#9B8AC4;color:white;padding:6px;border-radius:4px;font-size:0.75rem;">é€±${d}</th>`).join('')}</tr></thead>
          <tbody>${periods.map(p=>`<tr><td style="background:#7ECEC6;color:white;padding:4px;border-radius:4px;text-align:center;font-size:0.7rem;">${p}</td>${days.map(d=>{const key=`${d}-${p}`;const val=tt[key]||'';return`<td style="background:${val?'#F5E6B8':'#FFF9F0'};padding:3px;border-radius:4px;"><input type="text" id="tt_${key}" value="${val}" style="width:100%;padding:4px;border:1px solid #ddd;border-radius:3px;text-align:center;font-size:0.65rem;" /></td>`;}).join('')}</tr>`).join('')}</tbody>
        </table></div>
        <div style="margin-top:15px;"><label style="${styles.label}">èª²ç¨‹å®‰æ’èªªæ˜ï¼ˆæ¯è¡Œä¸€é–€èª²ï¼šèª²ç¨‹åç¨± æŠ½é›¢/å¤–åŠ  ç¯€æ•¸ï¼‰</label><textarea id="timetableNote" style="${styles.inputT}min-height:80px;" placeholder="ã€å°ˆé•·é ˜åŸŸã€‘å°ˆé•·æ¢ç´¢(ç¨‹å¼/ç©æœ¨) å¤–åŠ 1(æ—©è‡ªç¿’1) 1&#10;ã€æƒ…æ„é ˜åŸŸã€‘å‰µæ„äººç‰¹è³ª å¤–åŠ 1(æ—©è‡ªç¿’1) 1&#10;ã€å‰µé€ åŠ›é ˜åŸŸã€‘DFCå‰µæ„æŒ‘æˆ° å¤–åŠ 4(å‘¨äº”ä¸‹åˆ4) 4">${state.form.timetableNote||''}</textarea></div>`;
    }

    function renderMeetings() {
      const f=state.form;
      return `<h3 style="color:#9B8AC4;margin-bottom:15px;">ğŸ“ æœƒè­°ç´€éŒ„</h3>
        ${(f.meetings||[]).map((m,i)=>`<div style="background:#FFF9F0;border-radius:10px;padding:15px;margin-bottom:10px;border:2px solid #A8E6E0;position:relative;">
          ${i>0?`<button onclick="removeMeeting(${i})" style="position:absolute;top:10px;right:10px;width:24px;height:24px;border-radius:50%;border:none;background:#F5C4C4;color:white;cursor:pointer;">Ã—</button>`:''}
          <div style="margin-bottom:10px;"><label style="${styles.label}">æœƒè­°æ¨™é¡Œ</label><input type="text" id="meeting_title_${i}" value="${m.title||''}" style="${styles.inputT}" placeholder="114å­¸å¹´åº¦ç¬¬ä¸€å­¸æœŸ IGP æœŸåˆæœƒè­°" /></div>
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;">
            <div><label style="${styles.label}">æ—¥æœŸ</label><input type="text" id="meeting_date_${i}" value="${m.date||''}" style="${styles.inputT}" placeholder="114/8/5" /></div>
            <div><label style="${styles.label}">æ™‚é–“</label><input type="text" id="meeting_time_${i}" value="${m.time||''}" style="${styles.inputT}" placeholder="13:00-13:30" /></div>
            <div><label style="${styles.label}">åœ°é»</label><input type="text" id="meeting_location_${i}" value="${m.location||''}" style="${styles.inputT}" placeholder="è³‡å„ªç­æ•™å®¤" /></div>
            <div><label style="${styles.label}">è¨˜éŒ„è€…</label><input type="text" id="meeting_recorder_${i}" value="${m.recorder||''}" style="${styles.inputT}" /></div>
          </div>
          <div style="margin-top:10px;"><label style="${styles.label}">èˆ‡æœƒäººå“¡ï¼ˆæ¯è¡Œä¸€äººï¼‰</label><textarea id="meeting_attendees_${i}" style="${styles.inputT}min-height:80px;" placeholder="è³‡å„ªç­å°å¸« åŠ‰åŠ›ç‘„&#10;è³‡å„ªç­æ•™å¸« é«˜æ˜è–&#10;æ™®é€šç­å°å¸« æ´ªæ·‘å¿&#10;å®¶é•· æ—å°¹é›¯&#10;å­¸ç”Ÿ ææƒ³&#10;è¡Œæ”¿ä»£è¡¨ ç‰¹æ•™çµ„é•· é„­éº—ç¾">${m.attendees||''}</textarea></div>
          <div style="margin-top:10px;"><label style="${styles.label}">æœƒè­°ç´€éŒ„</label><textarea id="meeting_content_${i}" style="${styles.inputT}min-height:120px;">${m.content||''}</textarea></div>
        </div>`).join('')}
        <button onclick="addMeeting()" style="width:100%;padding:10px;border:2px dashed #7ECEC6;border-radius:10px;background:transparent;color:#7ECEC6;font-weight:700;cursor:pointer;">+ æ–°å¢æœƒè­°</button>`;
    }

    function addMeeting() { saveFormData(); state.form.meetings=[...(state.form.meetings||[]),{title:'',date:'',time:'',location:'',attendees:'',content:'',recorder:''}]; render(); }
    function removeMeeting(i) { saveFormData(); state.form.meetings=state.form.meetings.filter((_,idx)=>idx!==i); render(); }

    function renderExport() {
      const f=state.form;
      return `<div style="text-align:center;">
        <h3 style="color:#9B8AC4;margin-bottom:20px;">ğŸ“„ åŒ¯å‡º Word æ–‡ä»¶</h3>
        <div style="background:#F5E6B8;border-radius:15px;padding:20px;margin-bottom:20px;text-align:left;">
          <p><strong>å­¸ç”Ÿï¼š</strong>${f.studentName}ï¼ˆ${f.school} ${f.grade}å¹´${f.classNumber}ç­ï¼‰</p>
          <p><strong>å€‹ç®¡æ•™å¸«ï¼š</strong>${f.caseTeacher||'æœªå¡«'}</p>
          <p><strong>èª²ç¨‹æ•¸é‡ï¼š</strong>${(f.courses||[]).filter(c=>c.courseName).length} é–€</p>
          <p><strong>æœƒè­°æ¬¡æ•¸ï¼š</strong>${(f.meetings||[]).filter(m=>m.date).length} æ¬¡</p>
        </div>
        <button onclick="exportWord()" style="padding:18px 50px;border:none;border-radius:20px;background:linear-gradient(135deg,#7ECEC6 0%,#5EBEB6 100%);color:white;font-size:1.2rem;font-weight:700;cursor:pointer;">ğŸ“„ ä¸‹è¼‰ Wordï¼ˆèˆ‡PDFæ ¼å¼100%ç›¸åŒï¼‰</button>
        <p style="margin-top:10px;color:#666;font-size:0.85rem;">æ¨™æ¥·é«”ãƒ»ç„¡é¡è‰²ãƒ»å®Œå…¨è¤‡è£½PDFæ ¼å¼</p>
      </div>`;
    }

    // ===== Word åŒ¯å‡ºï¼ˆå®Œå…¨è¤‡è£½PDFæ ¼å¼ï¼‰=====
    async function exportWord() {
      saveFormData();
      const f = state.form;
      const { Document, Packer, Paragraph, TextRun, Table, TableRow, TableCell, BorderStyle, WidthType, AlignmentType, VerticalAlign, PageBreak } = docx;
      
      const FONT = "æ¨™æ¥·é«”";
      const border = { style: BorderStyle.SINGLE, size: 4, color: "000000" };
      const borders = { top: border, bottom: border, left: border, right: border };
      
      // å»ºç«‹å„²å­˜æ ¼ï¼ˆç„¡é¡è‰²ï¼‰
      const cell = (text, width, opts = {}) => new TableCell({
        borders,
        width: { size: width, type: WidthType.DXA },
        verticalAlign: VerticalAlign.CENTER,
        columnSpan: opts.span || 1,
        rowSpan: opts.rowSpan || 1,
        children: [new Paragraph({
          alignment: opts.align || AlignmentType.CENTER,
          spacing: { before: 60, after: 60 },
          children: [new TextRun({ text: text || '', font: FONT, size: opts.size || 24 })]
        })]
      });

      // å¤šè¡Œå„²å­˜æ ¼
      const cellLines = (lines, width, opts = {}) => new TableCell({
        borders,
        width: { size: width, type: WidthType.DXA },
        verticalAlign: VerticalAlign.TOP,
        columnSpan: opts.span || 1,
        rowSpan: opts.rowSpan || 1,
        children: (Array.isArray(lines) ? lines : [lines]).map(line => new Paragraph({
          alignment: opts.align || AlignmentType.LEFT,
          spacing: { before: 40, after: 40 },
          children: [new TextRun({ text: line || '', font: FONT, size: opts.size || 24 })]
        }))
      });

      const sections = [];

      // ===== ç¬¬1é ï¼šå°é¢ï¼ˆèˆ‡PDFç¬¬1é å®Œå…¨ç›¸åŒï¼‰=====
      sections.push(
        new Paragraph({
          alignment: AlignmentType.CENTER,
          spacing: { after: 400 },
          children: [new TextRun({ text: `æ¡ƒåœ’å¸‚è³‡è³¦å„ªç•°å­¸ç”Ÿ ${f.studentName} å€‹åˆ¥è¼”å°è¨ˆç•«ï¼ˆIGPï¼‰`, font: FONT, size: 36, bold: true })]
        }),
        new Paragraph({ spacing: { after: 100 }, children: [new TextRun({ text: `æ•™è‚²éšæ®µï¼šâ– ${f.educationStage||'åœ‹å°'}`, font: FONT, size: 24 })] }),
        new Paragraph({ spacing: { after: 100 }, children: [new TextRun({ text: `è³‡å„ªé¡åˆ¥ï¼šâ– ${f.giftedType||'å‰µé€ èƒ½åŠ›'}`, font: FONT, size: 24 })] }),
        new Paragraph({ spacing: { after: 300 }, children: [new TextRun({ text: `å®‰ç½®æ–¹å¼ï¼šâ– ${f.placementType||'åˆ†æ•£å¼è³‡æºç­'}`, font: FONT, size: 24 })] }),
        new Table({
          width: { size: 100, type: WidthType.PERCENTAGE },
          rows: [
            new TableRow({ children: [
              cell('å­¸å¹´+å­¸æœŸ', 1400), cell('å°±è®€å­¸æ ¡', 1400), cell('å¹´ç´š/ç­åˆ¥', 1400),
              cell('åŸç­å°å¸«', 1400), cell('å€‹ç®¡æ•™å¸«', 1400), cell('å®¶é•·ç°½å', 1400), cell('å­¸ç”Ÿç°½å', 1400),
            ]}),
            new TableRow({ children: [
              cell(`${f.schoolYear}å­¸å¹´åº¦\n${f.semester}`, 1400), cell(f.school, 1400), cell(`${f.grade}å¹´${f.classNumber}ç­`, 1400),
              cell(f.homeTeacher, 1400), cell(f.caseTeacher, 1400), cell('', 1400), cell('', 1400),
            ]}),
          ]
        }),
        new Paragraph({ children: [new PageBreak()] })
      );

      // ===== ç¬¬2é ï¼šä¸€ã€åŸºæœ¬è³‡æ–™èˆ‡å®¶åº­èƒŒæ™¯ï¼ˆèˆ‡PDFç¬¬2é å®Œå…¨ç›¸åŒï¼‰=====
      sections.push(
        new Paragraph({ spacing: { after: 200 }, children: [new TextRun({ text: 'ä¸€ã€åŸºæœ¬è³‡æ–™èˆ‡å®¶åº­èƒŒæ™¯', font: FONT, size: 28, bold: true })] }),
        new Paragraph({ spacing: { after: 100 }, children: [new TextRun({ text: 'ï¼ˆä¸€ï¼‰åŸºæœ¬è³‡æ–™', font: FONT, size: 24 })] }),
        new Table({
          width: { size: 100, type: WidthType.PERCENTAGE },
          rows: [
            new TableRow({ children: [
              cell('å­¸ç”Ÿå§“å', 1400), cell(f.studentName, 1800),
              cell('å‡ºç”Ÿæ—¥æœŸ', 1400), cell(f.birthDate, 1800),
              cell('æ€§åˆ¥', 800), cell(f.gender, 800),
            ]}),
            new TableRow({ children: [
              cell('é‘‘å®šæ–‡è™Ÿ', 1400), cellLines([f.identificationNumber || ''], 4600, { span: 3 }),
              cell('å­¸ç”Ÿ\nE-mail', 1000), cell(f.email || '', 1600),
            ]}),
            new TableRow({ children: [
              cell('ä½å®¶é›»è©±', 1400), cell(f.homePhone || '', 1800),
              cell('ä½ã€€å€', 1400), cellLines([f.address || ''], 4400, { span: 3 }),
            ]}),
            new TableRow({ children: [
              cell('æ³•å®šä»£ç†äºº', 1400), cell(f.guardian, 1800),
              cell('æ³•å®šä»£ç†äºº\nè¯çµ¡é›»è©±', 1600), cell(f.guardianPhone, 4200, { span: 3 }),
            ]}),
          ]
        }),
        new Paragraph({ spacing: { before: 200, after: 100 }, children: [new TextRun({ text: 'ï¼ˆäºŒï¼‰å®¶åº­æˆå“¡ï¼ˆå·²å°±æ¥­è€…è«‹å¡«æœå‹™æ©Ÿé—œï¼Œå°±å­¸è€…è«‹å¡«å°±è®€å­¸æ ¡ï¼‰', font: FONT, size: 24 })] }),
        new Table({
          width: { size: 100, type: WidthType.PERCENTAGE },
          rows: [
            new TableRow({ children: [
              cell('ç¨±è¬‚', 1000), cell('å§“å', 1600), cell('ç•¢æ¥­ç§‘ç³»', 1400),
              cell('å°ˆé•·', 1600), cell('è¯çµ¡é›»è©±', 1800), cell('æœå‹™æ©Ÿé—œ/å°±è®€å­¸æ ¡', 2600),
            ]}),
            new TableRow({ children: [
              cell(f.guardianRelation, 1000), cell(f.guardian, 1600), cell('', 1400),
              cell('', 1600), cell(f.guardianPhone, 1800), cell('', 2600),
            ]}),
          ]
        }),
        new Paragraph({ spacing: { before: 200, after: 100 }, children: [new TextRun({ text: 'ï¼ˆä¸‰ï¼‰å®¶åº­ç‹€æ³', font: FONT, size: 24 })] }),
        new Table({
          width: { size: 100, type: WidthType.PERCENTAGE },
          rows: [
            new TableRow({ children: [
              cell('å¯¦éš›ç…§é¡§è€…', 2500), cell(f.actualCaregiver, 2500),
              cell('å®¶åº­ç¶“æ¿Ÿç‹€æ³', 2500), cell(f.economicStatus, 2500),
            ]}),
            new TableRow({ children: [
              cell('å¯¦éš›ç…§é¡§è€…\nç®¡æ•™æ…‹åº¦', 2500), cell(f.parentingStyle, 2500),
              cell('èˆ‡å®¶äººäº’å‹•æƒ…å½¢', 2500), cell(f.familyInteraction, 2500),
            ]}),
            new TableRow({ children: [
              cell('å°å­©å­çš„æœŸæœ›', 2500), cellLines([f.parentExpectation || ''], 7500, { span: 3 }),
            ]}),
          ]
        }),
        new Paragraph({ children: [new PageBreak()] })
      );

      // ===== ç¬¬3é ï¼šï¼ˆå››ï¼‰æ•™è‚²è½‰éŠœç´€éŒ„ï¼ˆèˆ‡PDFç¬¬3é å®Œå…¨ç›¸åŒï¼‰=====
      sections.push(
        new Paragraph({ spacing: { after: 100 }, children: [new TextRun({ text: 'ï¼ˆå››ï¼‰æ•™è‚²è½‰éŠœç´€éŒ„', font: FONT, size: 24 })] }),
        new Table({
          width: { size: 100, type: WidthType.PERCENTAGE },
          rows: [
            new TableRow({ children: [
              cell('éšæ®µ', 1200), cell('æ ¡å', 1400), cell('ç­ç´š', 1200),
              cell('æ™®é€šç­å°å¸«', 1400), cell('è³‡å„ªæ•™è‚²\nå€‹ç®¡æ•™å¸«', 1400), cell('æœå‹™é¡å‹ï¼ˆå¯è¤‡é¸ï¼‰', 3400),
            ]}),
            new TableRow({ children: [
              cell('åœ‹å°\n3-4å¹´ç´š', 1200), cell(f.school, 1400), cell(`${f.grade}å¹´${f.classNumber}ç­`, 1200),
              cell(f.homeTeacher, 1400), cell(f.caseTeacher, 1400),
              cellLines(['â–¡ç¸®çŸ­ä¿®æ¥­å¹´é™', 'â– è³‡å„ªè³‡æºç­', 'â–¡è³‡å„ªæ•™è‚²æ–¹æ¡ˆ', 'ã€€â–¡æ ¡æœ¬â–¡å€åŸŸ', 'â–¡å·¡è¿´è¼”å°', 'ã€€â–¡èº«éšœâ–¡è³‡å„ª', 'â–¡èº«å¿ƒéšœç¤™è³‡æºç­', 'â–¡å…¶ä»–ï¼ˆè«‹èªªæ˜ï¼‰'], 3400, { size: 20 }),
            ]}),
            new TableRow({ children: [
              cell('åœ‹å°\n5-6å¹´ç´š', 1200), cell('', 1400), cell('', 1200), cell('', 1400), cell('', 1400),
              cellLines(['â–¡ç¸®çŸ­ä¿®æ¥­å¹´é™', 'â–¡è³‡å„ªè³‡æºç­', 'â–¡è³‡å„ªæ•™è‚²æ–¹æ¡ˆ', 'ã€€â–¡æ ¡æœ¬â–¡å€åŸŸ', 'â–¡å·¡è¿´è¼”å°', 'ã€€â–¡èº«éšœâ–¡è³‡å„ª', 'â–¡èº«å¿ƒéšœç¤™è³‡æºç­', 'â–¡å…¶ä»–ï¼ˆè«‹èªªæ˜ï¼‰'], 3400, { size: 20 }),
            ]}),
            new TableRow({ children: [
              cell('åœ‹ä¸­', 1200), cell('', 1400), cell('', 1200), cell('', 1400), cell('', 1400),
              cellLines(['â–¡ç¸®çŸ­ä¿®æ¥­å¹´é™', 'â–¡è³‡å„ªè³‡æºç­', 'â–¡è³‡å„ªæ•™è‚²æ–¹æ¡ˆ', 'ã€€â–¡æ ¡æœ¬â–¡å€åŸŸ', 'â–¡å·¡è¿´è¼”å°', 'ã€€â–¡èº«éšœâ–¡è³‡å„ª', 'â–¡èº«å¿ƒéšœç¤™è³‡æºç­', 'â–¡å…¶ä»–ï¼ˆè«‹èªªæ˜ï¼‰'], 3400, { size: 20 }),
            ]}),
          ]
        }),
        new Paragraph({ children: [new PageBreak()] })
      );

      // ===== ç¬¬4é ï¼šäºŒã€é‘‘å®šè©•é‡èˆ‡è¡¨ç¾è¨˜éŒ„ï¼ˆèˆ‡PDFç¬¬4é å®Œå…¨ç›¸åŒï¼‰=====
      sections.push(
        new Paragraph({ spacing: { after: 200 }, children: [new TextRun({ text: 'äºŒã€é‘‘å®šè©•é‡èˆ‡è¡¨ç¾è¨˜éŒ„', font: FONT, size: 28, bold: true })] }),
        new Paragraph({ spacing: { after: 100 }, children: [new TextRun({ text: 'ï¼ˆä¸€ï¼‰é‘‘å®šè³‡æ–™ï¼ˆä¾æ“šé‘‘å®šçµæœé€šçŸ¥æ›¸ï¼‰', font: FONT, size: 24 })] }),
        new Table({
          width: { size: 100, type: WidthType.PERCENTAGE },
          rows: [
            new TableRow({ children: [
              cell('è©•é‡å·¥å…·åç¨±', 4000), cell('æ–½æ¸¬æ—¥æœŸ', 2000),
              cell('è©•é‡çµæœï¼ˆæ“‡ä¸€å¡«å¯«ï¼‰', 4000, { span: 2 }),
            ]}),
            new TableRow({ children: [
              cell('', 4000), cell('', 2000), cell('æ¨™æº–åˆ†æ•¸', 2000), cell('ç™¾åˆ†ç­‰ç´š', 2000),
            ]}),
            new TableRow({ children: [ cell('', 4000), cell('', 2000), cell('', 2000), cell('', 2000) ]}),
          ]
        }),
        new Paragraph({ spacing: { before: 50, after: 150 }, children: [new TextRun({ text: 'â€»è©•é‡å·¥å…·åç¨±æ¬„ä½:ä¸€èˆ¬æ™ºèƒ½è³‡å„ªæ¸¬é©—ï¼Œåƒ…éœ€å¡«å¯«ã€Œåœ˜é«”/å€‹åˆ¥æ™ºåŠ›æ¸¬é©—ã€ã€‚', font: FONT, size: 20 })] }),
        new Paragraph({ spacing: { before: 100, after: 100 }, children: [new TextRun({ text: 'ï¼ˆäºŒï¼‰ç”Ÿæ¶¯ã€èˆˆè¶£èˆ‡å…¶ä»–æ¸¬é©—/é‡è¡¨', font: FONT, size: 24 })] }),
        new Table({
          width: { size: 100, type: WidthType.PERCENTAGE },
          rows: [
            new TableRow({ children: [ cell('æ¸¬é©—åç¨±', 4000), cell('æ¸¬é©—æ—¥æœŸ', 2000), cell('è©•é‡çµæœ', 4000) ]}),
            new TableRow({ children: [ cell('', 4000), cell('', 2000), cell('', 4000) ]}),
          ]
        }),
        new Paragraph({ children: [new PageBreak()] })
      );

      // ===== ç¬¬5é ï¼šèˆˆè¶£åˆ†æèˆ‡å¾—çç´€éŒ„ï¼ˆèˆ‡PDFç¬¬5é å®Œå…¨ç›¸åŒï¼‰=====
      sections.push(
        new Paragraph({ spacing: { after: 100 }, children: [new TextRun({ text: 'ï¼ˆä¸‰ï¼‰èˆˆè¶£åˆ†æï¼ˆå¯è¤‡é¸ï¼‰', font: FONT, size: 24 })] }),
        new Table({
          width: { size: 100, type: WidthType.PERCENTAGE },
          rows: [
            new TableRow({ children: [ cell('ç§‘å­¸èˆˆè¶£', 3300), cell('äººæ–‡èˆ‡è—è¡“èˆˆè¶£', 3400), cell('å…¶ä»–', 3300) ]}),
            new TableRow({ children: [
              cellLines(['â–¡ ' + (f.scienceInterests||[]).join(', ')], 3300),
              cellLines(['â–¡ ' + (f.humanitiesInterests||[]).join(', ')], 3400),
              cellLines(['â–¡ ' + (f.otherInterests||[]).join(', ')], 3300),
            ]}),
          ]
        }),
        new Paragraph({ spacing: { before: 200, after: 100 }, children: [new TextRun({ text: 'ï¼ˆå››ï¼‰å¾—çç´€éŒ„ï¼ˆæª¢é™„ç›¸é—œå­¸ç§‘ç«¶è³½å¾—çè³‡æ–™ï¼‰', font: FONT, size: 24 })] }),
        new Table({
          width: { size: 100, type: WidthType.PERCENTAGE },
          rows: [
            new TableRow({ children: [
              cell('', 400), cell('æ—¥æœŸ', 1600), cell('ç«¶è³½/æ´»å‹•åç¨±', 3000),
              cell('ä¸»è¾¦å–®ä½', 1800), cell('çé …', 1400), cell('å¾—çé¡å‹', 1400),
            ]}),
            ...[1,2,3,4,5,6,7,8].map(n => new TableRow({ children: [
              cell(n.toString(), 400), cell('', 1600), cell('', 3000), cell('', 1800), cell('', 1400), cell('', 1400),
            ]})),
          ]
        }),
        new Paragraph({ children: [new PageBreak()] })
      );

      // ===== ç¬¬6é ï¼šåœ‹å°éšæ®µæ¨™é¡Œé ï¼ˆèˆ‡PDFç¬¬6é å®Œå…¨ç›¸åŒï¼‰=====
      sections.push(
        new Paragraph({ alignment: AlignmentType.CENTER, spacing: { before: 2000, after: 600 }, children: [new TextRun({ text: `åœ‹å°éšæ®µ: ${f.grade}å¹´ç´š`, font: FONT, size: 36, bold: true })] }),
        new Paragraph({ alignment: AlignmentType.CENTER, spacing: { after: 300 }, children: [new TextRun({ text: 'ä¸‰ã€å„ªå¼±å‹¢åˆ†æ', font: FONT, size: 28 })] }),
        new Paragraph({ alignment: AlignmentType.CENTER, spacing: { after: 300 }, children: [new TextRun({ text: 'å››ã€èª²ç¨‹éœ€æ±‚è©•ä¼°', font: FONT, size: 28 })] }),
        new Paragraph({ alignment: AlignmentType.CENTER, spacing: { after: 300 }, children: [new TextRun({ text: 'äº”ã€æ•™è‚²ç›®æ¨™èˆ‡è¼”å°é‡é»', font: FONT, size: 28 })] }),
        new Paragraph({ alignment: AlignmentType.CENTER, spacing: { after: 300 }, children: [new TextRun({ text: 'å…­ã€ç›¸é—œæœƒè­°è¨˜éŒ„', font: FONT, size: 28 })] }),
        new Paragraph({ children: [new PageBreak()] })
      );

      // ===== ç¬¬7é ï¼šä¸‰ã€å„ªå¼±å‹¢èƒ½åŠ›è©•æï¼ˆèˆ‡PDFç¬¬7é å®Œå…¨ç›¸åŒï¼‰=====
      sections.push(
        new Paragraph({ spacing: { after: 100 }, children: [new TextRun({ text: 'ä¸‰ã€å„ªå¼±å‹¢èƒ½åŠ›è©•æï¼ˆæ¯å­¸å¹´è©•ä¼°ä¸€æ¬¡ï¼‰', font: FONT, size: 28, bold: true })] }),
        new Paragraph({ spacing: { after: 50 }, children: [new TextRun({ text: 'ç›¸é—œè³‡å„ªèƒ½åŠ›åƒè€ƒè™Ÿç¢¼', font: FONT, size: 22 })] }),
        new Table({
          width: { size: 100, type: WidthType.PERCENTAGE },
          rows: [
            new TableRow({ children: [ cell('èªçŸ¥ç‰¹è³ª', 3300), cell('æƒ…æ„ç‰¹è³ª', 3400), cell('å­¸ç§‘èƒ½åŠ›', 3300) ]}),
            new TableRow({ children: [
              cellLines(['â‘ è§€å¯Ÿèƒ½åŠ›','â‘¡è¨˜æ†¶èƒ½åŠ›','â‘¢ç†è§£èƒ½åŠ›','â‘£æ¨ç†èƒ½åŠ›','â‘¤åˆ†æèƒ½åŠ›','â‘¥æ‡‰ç”¨èƒ½åŠ›','â‘¦è©•é‘‘èƒ½åŠ›','â‘§å‰µé€ èƒ½åŠ›','â‘¨æ‰¹åˆ¤èƒ½åŠ›','â‘©å•é¡Œè§£æ±º','â‘ªå¾Œè¨­èƒ½åŠ›','â‘«å…¶ä»–ï¼š','ã€€ã€€___________'], 3300, { size: 20 }),
              cellLines(['â‘¬å°ˆæ³¨èƒ½åŠ›','â‘­æˆå°±å‹•æ©Ÿ','â‘®è¦æ±‚å®Œç¾','â‘¯æºé€šå”èª¿','â‘°æƒ…ç·’æ§åˆ¶','â‘±æŒ«æŠ˜å®¹å¿','â‘²æ­£å‘æ€è€ƒ','â‘³é ˜å°èƒ½åŠ›','ã‰‘åˆä½œèƒ½åŠ›','ã‰’è‡ªä¿¡å¿ƒ','ã‰“åŒç†å¿ƒ','ã‰”å¾©åŸåŠ›','ã‰•å…¶ä»–ï¼š','ã€€ã€€___________'], 3400, { size: 20 }),
              cellLines(['ã‰–æ•¸å­¸','è‡ªç„¶','ã€€ã‰—ç‰©ç†','ã€€ã‰˜ç”Ÿç‰©','ã€€ã‰™åŒ–å­¸','ã€€ã‰šåœ°ç§‘','èªæ–‡','ã€€ã‰›åœ‹æ–‡','ã€€ã‰œè‹±æ–‡','ç¤¾æœƒ','ã€€ã‰æ­·å²','ã€€ã‰åœ°ç†','ã€€ã‰Ÿå…¬æ°‘','ãŠ±è³‡è¨Š','ãŠ²ç”Ÿç§‘','ãŠ³å…¶ä»–ï¼š','ã€€ã€€___________'], 3300, { size: 20 }),
            ]}),
          ]
        }),
        new Paragraph({ spacing: { before: 150 }, children: [] }),
        new Table({
          width: { size: 100, type: WidthType.PERCENTAGE },
          rows: [
            new TableRow({ children: [
              cell('å¹´ç´š', 800), cell('å¡«å¯«æ—¥æœŸ', 1500), cell('å¡«å¯«è€…\n(å­¸ç”Ÿ/å®¶é•·/æ•™å¸«)', 2500),
              cell('å„ªå‹¢èƒ½åŠ›(å¡«ä»£è™Ÿ)', 2600), cell('å¼±å‹¢èƒ½åŠ›(å¡«ä»£è™Ÿ)', 2600),
            ]}),
            new TableRow({ children: [
              cell(f.grade, 800),
              cell(f.analysisDate || '', 1500),
              cell(f.analysisWriter || `${f.caseTeacher}(æ•™å¸«)`, 2500),
              cellLines([(f.strengths||[]).join(' ')], 2600, { size: 18 }),
              cellLines([(f.weaknesses||[]).join(' ')], 2600, { size: 18 }),
            ]}),
          ]
        }),
        new Paragraph({ spacing: { before: 100, after: 50 }, children: [new TextRun({ text: 'å„ªå¼±å‹¢èƒ½åŠ›ç¶œåˆè©•æ(è³ªæ€§æè¿°)', font: FONT, size: 22 })] }),
        new Table({
          width: { size: 100, type: WidthType.PERCENTAGE },
          rows: [
            new TableRow({ children: [ cellLines((f.analysisDescription || '').split('\n'), 10000) ]}),
          ]
        }),
        new Paragraph({ children: [new PageBreak()] })
      );

      // ===== å››ã€èª²ç¨‹éœ€æ±‚è©•ä¼° & äº”ã€æ•™è‚²ç›®æ¨™èˆ‡è¼”å°é‡é» =====
      sections.push(
        new Paragraph({ spacing: { after: 100 }, children: [new TextRun({ text: 'å››ã€èª²ç¨‹éœ€æ±‚è©•ä¼°ï¼ˆæ¯å­¸æœŸè©•ä¼°ä¸€æ¬¡ï¼‰', font: FONT, size: 24 })] }),
        new Paragraph({ spacing: { after: 100 }, children: [new TextRun({ text: 'äº”ã€æ•™è‚²ç›®æ¨™èˆ‡è¼”å°é‡é»ï¼ˆæ¯å­¸æœŸè©•ä¼°ä¸€æ¬¡ï¼‰', font: FONT, size: 24 })] }),
        new Paragraph({ spacing: { after: 100 }, children: [new TextRun({ text: 'å«å­¸ç§‘ã€å°ˆé¡Œã€ç¨ç«‹ç ”ç©¶èˆ‡ç‰¹æ®Šæ•™è‚²éœ€æ±‚èª²ç¨‹ç­‰', font: FONT, size: 20 })] }),
        new Table({
          width: { size: 100, type: WidthType.PERCENTAGE },
          rows: [
            new TableRow({ children: [
              cell('é ˜åŸŸ\nå­¸ç¿’\nèª²ç¨‹', 1500, { rowSpan: 2 }),
              cellLines(['åœ‹èªæ–‡ã€€è‹±èªæ–‡ã€€ç¬¬äºŒå¤–åœ‹èªã€€æ•¸å­¸é ˜åŸŸ'], 8500, { span: 5 }),
            ]}),
            new TableRow({ children: [
              cellLines(['ç¤¾æœƒé ˜åŸŸã€€è‡ªç„¶ç§‘å­¸é ˜åŸŸã€€è—è¡“é ˜åŸŸ'], 8500, { span: 5 }),
            ]}),
            new TableRow({ children: [
              cell('ç‰¹æ®Š\néœ€æ±‚\nèª²ç¨‹', 1500, { rowSpan: 2 }),
              cellLines(['â– å‰µé€ èƒ½åŠ›ã€€â–¡é ˜å°æ‰èƒ½ã€€â–¡ç¨ç«‹ç ”ç©¶ã€€â– æƒ…æ„ç™¼å±•ã€€â– å°ˆé•·é ˜åŸŸ'], 8500, { span: 5 }),
            ]}),
            new TableRow({ children: [
              cellLines(['â–¡å‰µé€ èƒ½åŠ›ã€€â–¡é ˜å°æ‰èƒ½ã€€â–¡ç¨ç«‹ç ”ç©¶ã€€â–¡æƒ…æ„ç™¼å±•ã€€â–¡å°ˆé•·é ˜åŸŸ'], 8500, { span: 5 }),
            ]}),
          ]
        }),
        new Paragraph({ spacing: { after: 200 }, children: [] })
      );

      // æ¯å€‹èª²ç¨‹
      (f.courses || []).filter(c => c.courseName).forEach((course, idx) => {
        sections.push(
          new Table({
            width: { size: 100, type: WidthType.PERCENTAGE },
            rows: [
              new TableRow({ children: [
                cell('å­¸ç¿’é ˜åŸŸ', 1400), cell(course.domain, 2800),
                cell('èª²ç¨‹åç¨±', 1400), cell(course.courseName, 2000),
                cell('æˆèª²æ•™å¸«', 1200), cell(course.teacher, 1600),
              ]}),
              new TableRow({ children: [
                cell('å­¸å¹´/å­¸æœŸ\nç›®æ¨™', 1400),
                cellLines((course.goals || '').split('\n'), 9000, { span: 5 }),
              ]}),
              new TableRow({ children: [
                cell('æ•™è‚²éœ€æ±‚èˆ‡\nè¼”å°å»ºè­°äº‹\né …', 1400, { rowSpan: 3 }),
                cellLines([
                  'èªçŸ¥æ•™å­¸æ–¹é¢',
                  'å…§å®¹èª¿æ•´ï¼ˆâ– åŠ æ·±åŠ å»£ã€€â–¡ç¨ç«‹ç ”ç©¶ã€€â–¡æ¿ƒç¸®åŠ é€Ÿ/ç¸®çŸ­ä¿®æ¥­ã€€â–¡å…¶ä»–ã€€ã€€ã€€ï¼‰',
                  'æ­·ç¨‹èª¿æ•´ï¼ˆâ– æ€è€ƒè¨“ç·´ã€€â–¡ç ”ç©¶æ–¹æ³•è¨“ç·´ã€€â– å­¸ç¿’ç­–ç•¥è¨“ç·´ã€€â– ç§‘æŠ€å·¥å…·é‹ç”¨ã€€â–¡å…¶ä»–ã€€ã€€ã€€ï¼‰',
                  'çµæœèª¿æ•´ï¼ˆâ–¡ä½œæ¥­èª¿æ•´ã€€â–¡è©•é‡èª¿æ•´ã€€â– æˆæœå“è³ªã€€â– æˆæœåˆ†äº«ã€€â–¡å…¶ä»–ã€€ã€€ã€€ï¼‰',
                  'ç’°å¢ƒèª¿æ•´ï¼ˆâ–¡è‡ªå­¸ç©ºé–“ã€€â–¡æ ¡å¤–å­¸ç¿’ã€€â–¡èˆˆè¶£ä¸­å¿ƒã€€â–¡æ ¡å¤–äº¤æµã€€â–¡å…¶ä»–ã€€ã€€ã€€ï¼‰',
                ], 9000, { span: 5, size: 20 }),
              ]}),
              new TableRow({ children: [
                cellLines([
                  'æƒ…æ„è¼”å°æ–¹é¢',
                  'è¼”å°é‡é»ï¼ˆâ– æƒ…æ„æŠ€èƒ½ã€€â–¡è¦ªå­äº’å‹•ã€€â– åŒå„•äº’å‹•ã€€â– æƒ…ç·’èª¿é©ã€€â–¡å£“åŠ›èª¿é©ã€€â– è‡ªæˆ‘èªè­˜ã€€â–¡æœå‹™é—œæ‡·ã€€â–¡è‡ªæˆ‘æœŸå¾…ã€€â– å­¸ç¿’å‹•æ©Ÿã€€â–¡ç”Ÿæ¶¯è¦åŠƒã€€â–¡å…¶ä»–ã€€ã€€ã€€ï¼‰',
                  'è¼”å°æ–¹å¼ï¼ˆâ– èå…¥å­¸ç§‘ã€€â– åœ˜é«”è¼”å°ã€€â–¡å°çµ„è¼”å°ã€€â–¡å€‹åˆ¥è¼”å°ã€€â–¡è¦ªè·æ•™è‚²ã€€â–¡å…¶ä»–ã€€ã€€ã€€ï¼‰',
                ], 9000, { span: 5, size: 20 }),
              ]}),
              new TableRow({ children: [
                cellLines([
                  'æŠ€èƒ½åŸ¹è¨“æ–¹é¢',
                  'åŸ¹è¨“é‡é»ï¼ˆâ–¡ç”Ÿæ´»æŠ€èƒ½ã€€â– å­¸ç¿’æŠ€èƒ½ã€€â–¡æ™‚é–“ç®¡ç†ã€€â–¡è‡ªæˆ‘ç®¡ç†ã€€â–¡å…¶ä»–ã€€ã€€ã€€ï¼‰',
                  'åŸ¹è¨“æ–¹å¼ï¼ˆâ– èå…¥å­¸ç§‘ã€€â–¡åœ˜é«”è¨“ç·´ã€€â–¡å°çµ„è¨“ç·´ã€€â–¡å€‹åˆ¥è¨“ç·´ã€€â–¡å…¶ä»–ã€€ã€€ã€€ï¼‰',
                ], 9000, { span: 5, size: 20 }),
              ]}),
            ]
          }),
          new Paragraph({ spacing: { after: 100 }, children: [] }),
          new Table({
            width: { size: 100, type: WidthType.PERCENTAGE },
            rows: [
              new TableRow({ children: [
                cell('é …æ¬¡', 700), cell('å­¸ç¿’è¡¨ç¾èª¿æ•´\nï¼ˆèª¿æ•´éƒ¨åˆ†è«‹åº•ç·šè¨»è¨˜ï¼‰', 5500),
                cell('è©•é‡æ–¹å¼', 1600), cell('è©•é‡çµæœ', 2200, { span: 2 }),
              ]}),
              new TableRow({ children: [
                cell('', 700), cell('', 5500), cell('', 1600),
                cell('å­¸ç”Ÿ\nè‡ªè©•', 1100), cell('æ•™å¸«\nè©•åˆ†', 1100),
              ]}),
              ...[1,2,3,4,5].map(n => new TableRow({ children: [
                cell(n.toString(), 700), cell('', 5500), cell('', 1600), cell('', 1100), cell('', 1100),
              ]})),
            ]
          }),
          new Paragraph({ spacing: { after: 200 }, children: [] })
        );
      });

      sections.push(new Paragraph({ children: [new PageBreak()] }));

      // ===== èª²è¡¨ï¼ˆèˆ‡PDFç¬¬12é å®Œå…¨ç›¸åŒï¼‰=====
      const days = ['ä¸€','äºŒ','ä¸‰','å››','äº”'];
      const periods = [
        { name: 'æœè£', time: '' },
        { name: 'æ—©è‡ªç¿’', time: '08:00~08:40' },
        { name: '1', time: '08:45~09:25' },
        { name: '2', time: '09:35~10:15' },
        { name: '3', time: '10:30~11:10' },
        { name: '4', time: '11:20~12:00' },
        { name: 'åˆä¼‘', time: '12:25~13:05' },
        { name: '5', time: '13:10~13:50' },
        { name: '6', time: '14:00~14:40' },
        { name: '7', time: '14:55~15:35' },
      ];
      const tt = f.timetable || {};

      sections.push(
        new Paragraph({ spacing: { after: 100 }, children: [new TextRun({ text: 'ï¼ˆäºŒï¼‰èª²è¡¨(è«‹æ¨™è¨»æŠ½é›¢åŠå¤–åŠ èª²ç¨‹ä¹‹èª²ç¨‹åç¨±)', font: FONT, size: 24 })] }),
        new Paragraph({ alignment: AlignmentType.CENTER, spacing: { after: 50 }, children: [new TextRun({ text: `æ¡ƒåœ’å¸‚æ¡ƒåœ’å€${f.school}åœ‹æ°‘å°å­¸ ${f.schoolYear}å­¸å¹´åº¦`, font: FONT, size: 22 })] }),
        new Paragraph({ alignment: AlignmentType.CENTER, spacing: { after: 100 }, children: [new TextRun({ text: `${f.grade}å¹´${f.classNumber}ç­ è³‡å„ªç­å­¸ç”Ÿèª²è¡¨ã€€å°å¸« ${f.homeTeacher}è€å¸«`, font: FONT, size: 22 })] }),
        new Table({
          width: { size: 100, type: WidthType.PERCENTAGE },
          rows: [
            new TableRow({ children: [
              cell('ã€€ã€€æ˜ŸæœŸ\nç¯€æ¬¡', 1800),
              cell('ä¸€', 1640), cell('äºŒ', 1640), cell('ä¸‰', 1640), cell('å››', 1640), cell('äº”', 1640),
            ]}),
            ...periods.map(p => new TableRow({ children: [
              cell(p.name + (p.time ? '\n' + p.time : ''), 1800, { size: 18 }),
              ...days.map(d => cell(tt[`${d}-${p.name}`] || '', 1640, { size: 18 }))
            ]})),
          ]
        }),
        new Paragraph({ spacing: { before: 100, after: 50 }, children: [new TextRun({ text: 'èª²ç¨‹å®‰æ’èªªæ˜ï¼š', font: FONT, size: 22 })] }),
        new Table({
          width: { size: 100, type: WidthType.PERCENTAGE },
          rows: [
            new TableRow({ children: [
              cell('ã€ç‰¹éœ€é ˜åŸŸã€‘èª²ç¨‹åç¨±', 4000), cell('æŠ½é›¢ï¼å¤–åŠ ', 3000), cell('ç¯€æ•¸', 3000),
            ]}),
            ...(f.timetableNote || '').split('\n').filter(l=>l.trim()).map(line => {
              const parts = line.split(/\s+/);
              return new TableRow({ children: [
                cell(parts[0] || '', 4000, { align: AlignmentType.LEFT }),
                cell(parts[1] || '', 3000),
                cell(parts[2] || '', 3000),
              ]});
            }),
          ]
        }),
        new Paragraph({ children: [new PageBreak()] })
      );

      // ===== å…­ã€ç›¸é—œæœƒè­°ç´€éŒ„ï¼ˆèˆ‡PDFç¬¬18é å®Œå…¨ç›¸åŒï¼‰=====
      sections.push(
        new Paragraph({ spacing: { after: 100 }, children: [new TextRun({ text: 'å…­ã€ç›¸é—œæœƒè­°ç´€éŒ„', font: FONT, size: 28, bold: true })] }),
        new Paragraph({ spacing: { after: 150 }, children: [new TextRun({ text: 'â€»å¯ç”¨å„æ ¡æœƒè­°ç´€éŒ„æ ¼å¼ï¼Œä½†æ‡‰åŒ…å«æœƒè­°æ—¥æœŸã€åœ°é»ã€èˆ‡æœƒäººå“¡ã€è¨è«–äº‹é …ã€å®¶é•·/å­¸ç”Ÿå›é¥‹æ„è¦‹ã€æ±ºè­°æˆ–ä¿®æ­£å¾Œä¹‹èª²ç¨‹å…§å®¹ç°¡è¿°ã€å„ç›¸é—œè™•å®¤æ ¸ç« è™•ï¼Œä¸¦æ‡‰é™„ä¸Šç°½åˆ°è¡¨ã€‚', font: FONT, size: 18 })] })
      );

      (f.meetings || []).filter(m => m.date).forEach((meeting, idx) => {
        sections.push(
          new Paragraph({ spacing: { before: 150, after: 100 }, children: [new TextRun({ text: meeting.title || `${f.schoolYear}å­¸å¹´åº¦${f.semester} IGP æœƒè­°`, font: FONT, size: 24, bold: true })] }),
          new Table({
            width: { size: 100, type: WidthType.PERCENTAGE },
            rows: [
              new TableRow({ children: [
                cell('æœƒè­°æ—¥æœŸ:', 1100), cell(meeting.date, 1400),
                cell('æ™‚é–“:', 700), cell(meeting.time, 1600),
                cell('åœ°é»:', 700), cell(meeting.location, 1600),
                cell('è¨˜éŒ„è€…:', 900), cell(meeting.recorder, 1200),
              ]}),
            ]
          }),
          new Paragraph({ spacing: { before: 100, after: 50 }, children: [new TextRun({ text: 'èˆ‡æœƒäººå“¡: (ç°½åˆ°è¡¨)', font: FONT, size: 22 })] }),
          new Table({
            width: { size: 100, type: WidthType.PERCENTAGE },
            rows: [
              new TableRow({ children: [ cellLines((meeting.attendees || '').split('\n'), 10000) ]}),
            ]
          }),
          new Paragraph({ spacing: { before: 100, after: 50 }, children: [new TextRun({ text: 'æœƒè­°ç´€éŒ„ï¼šï¼ˆæ‡‰å«è¨è«–äº‹é …ã€å®¶é•·/å­¸ç”Ÿå›é¥‹æ„è¦‹ã€æ±ºè­°æˆ–ä¿®æ­£èª²ç¨‹å…§å®¹ï¼‰', font: FONT, size: 22 })] }),
          new Table({
            width: { size: 100, type: WidthType.PERCENTAGE },
            rows: [
              new TableRow({ children: [ cellLines((meeting.content || '').split('\n'), 10000) ]}),
            ]
          }),
          new Paragraph({ spacing: { before: 150, after: 50 }, children: [new TextRun({ text: 'æ ¸ç« è™•', font: FONT, size: 22 })] }),
          new Table({
            width: { size: 100, type: WidthType.PERCENTAGE },
            rows: [
              new TableRow({ children: [
                cell('å€‹ç®¡æ•™å¸«', 2500), cell('ç‰¹æ•™çµ„é•·', 2500), cell('è¼”å°ä¸»ä»»', 2500), cell('æ ¡é•·', 2500),
              ]}),
              new TableRow({ children: [ cell('', 2500), cell('', 2500), cell('', 2500), cell('', 2500) ]}),
            ]
          }),
          new Paragraph({ spacing: { after: 200 }, children: [] })
        );
      });

      sections.push(new Paragraph({ children: [new PageBreak()] }));

      // ===== ä¸ƒã€é‡æ–°å®‰ç½®ç´€éŒ„ & å…«ã€æ™¤è«‡æˆ–è¼”å°ç´€éŒ„ï¼ˆèˆ‡PDFç¬¬21é å®Œå…¨ç›¸åŒï¼‰=====
      sections.push(
        new Paragraph({ spacing: { after: 100 }, children: [new TextRun({ text: 'ä¸ƒã€é‡æ–°å®‰ç½®ç´€éŒ„', font: FONT, size: 28, bold: true })] }),
        new Table({
          width: { size: 100, type: WidthType.PERCENTAGE },
          rows: [
            new TableRow({ children: [
              cell('æ—¥æœŸ', 1500), cell('è©•ä¼°éœ€æ±‚èªªæ˜', 3500), cell('è©•ä¼°çµæœæ¦‚è¦æ•˜è¿°', 3500), cell('è¨˜éŒ„äººå“¡', 1500),
            ]}),
            new TableRow({ children: [ cell('', 1500), cell('', 3500), cell('', 3500), cell('', 1500) ]}),
          ]
        }),
        new Paragraph({ spacing: { before: 300, after: 100 }, children: [new TextRun({ text: 'å…«ã€æ™¤è«‡æˆ–è¼”å°ç´€éŒ„', font: FONT, size: 28, bold: true })] }),
        new Table({
          width: { size: 100, type: WidthType.PERCENTAGE },
          rows: [
            new TableRow({ children: [
              cell('æ—¥æœŸ', 1000), cell('åƒèˆ‡äººå“¡', 1200), cell('äº‹ä»¶', 1500), cell('å…§å®¹æ¦‚è¦æ•˜è¿°', 2800), cell('è™•é‡æ–¹å¼', 2000), cell('è¨˜éŒ„äººå“¡', 1000),
            ]}),
            new TableRow({ children: [
              cell('', 1000),
              cellLines(['â–¡æœ¬äºº','â–¡æ¯è¦ª','â–¡çˆ¶è¦ª','â–¡å…¶ä»–','________'], 1200, { size: 18 }),
              cell('', 1500), cell('', 2800),
              cellLines(['â–¡ è½‰ä»‹äºŒç´š','â–¡ å”åŒå°å¸«','â–¡ å®šæœŸæ™¤è«‡','â–¡ æŒçºŒè§€å¯Ÿ','â–¡ å…¶ä»– _______'], 2000, { size: 18 }),
              cell('', 1000),
            ]}),
            new TableRow({ children: [
              cell('', 1000),
              cellLines(['â–¡æœ¬äºº','â–¡æ¯è¦ª','â–¡çˆ¶è¦ª','â–¡å…¶ä»–','________'], 1200, { size: 18 }),
              cell('', 1500), cell('', 2800),
              cellLines(['â–¡ è½‰ä»‹äºŒç´š','â–¡ å”åŒå°å¸«','â–¡ å®šæœŸæ™¤è«‡','â–¡ æŒçºŒè§€å¯Ÿ','â–¡ å…¶ä»– _______'], 2000, { size: 18 }),
              cell('', 1000),
            ]}),
          ]
        }),
        new Paragraph({ spacing: { before: 100 }, children: [new TextRun({ text: 'â€»è‡ªè¡Œå¢åˆªè¡¨æ ¼ã€‚', font: FONT, size: 18 })] }),
        new Paragraph({ children: [new TextRun({ text: 'é™„ä»¶ï¼šå¦‚å­¸ç¿’ç´€éŒ„è¡¨ã€å¾—çè³‡æ–™ã€æ¸¬é©—ç´€éŒ„ç­‰', font: FONT, size: 18 })] }),
      );

      const doc = new Document({
        styles: { default: { document: { run: { font: FONT, size: 24 } } } },
        sections: [{ 
          properties: { 
            page: { 
              size: { width: 11906, height: 16838 }, 
              margin: { top: 1134, right: 1134, bottom: 1134, left: 1134 } 
            } 
          }, 
          children: sections 
        }]
      });

      const blob = await Packer.toBlob(doc);
      saveAs(blob, `${f.schoolYear}å­¸å¹´åº¦_${f.school}_${f.grade}å¹´${f.classNumber}ç­_${f.studentName}_IGP.docx`);
      showToast('âœ… Word æ–‡ä»¶å·²ä¸‹è¼‰ï¼');
    }

    function saveFormData() {
      ['studentName','birthDate','gender','email','schoolYear','school','grade','classNumber','homeTeacher','guardian','guardianRelation','guardianPhone','address','actualCaregiver','economicStatus','parentingStyle','familyInteraction','parentExpectation','identificationNumber','caseTeacher','analysisDescription','analysisDate','analysisWriter','educationStage','giftedType','placementType','timetableNote'].forEach(field => {
        const el = document.getElementById(field);
        if (el) state.form[field] = el.value;
      });
      (state.form.courses || []).forEach((c, i) => {
        ['domain','name','teacher','goals'].forEach(k => {
          const el = document.getElementById(`course_${k}_${i}`);
          if (el) state.form.courses[i][k === 'name' ? 'courseName' : k] = el.value;
        });
      });
      ['ä¸€','äºŒ','ä¸‰','å››','äº”'].forEach(d => {
        ['æ—©è‡ªç¿’','1','2','3','4','åˆä¼‘','5','6','7'].forEach(p => {
          const el = document.getElementById(`tt_${d}-${p}`);
          if (el) { if (!state.form.timetable) state.form.timetable = {}; state.form.timetable[`${d}-${p}`] = el.value; }
        });
      });
      (state.form.meetings || []).forEach((m, i) => {
        ['title','date','time','location','attendees','content','recorder'].forEach(k => {
          const el = document.getElementById(`meeting_${k}_${i}`);
          if (el) state.form.meetings[i][k] = el.value;
        });
      });
    }

    function bindEvents() {
      document.querySelectorAll('input, select, textarea').forEach(el => {
        el.addEventListener('change', saveFormData);
        el.addEventListener('blur', saveFormData);
      });
      const pwdInput = document.getElementById('passwordInput');
      if (pwdInput) pwdInput.addEventListener('keypress', e => { if (e.key === 'Enter') handleLogin(); });
    }

    render();
  </script>
</body>
</html>
